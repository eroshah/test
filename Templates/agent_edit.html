<!DOCTYPE html>
<html lang="{{ current_lang }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if agent %}{{ t.edit_agent }}{% else %}{{ t.create_agent }}{% endif %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>{% if agent %}{{ t.edit_agent }}{% else %}{{ t.create_agent }}{% endif %}</h1>
            <a href="/?DOMAIN={{ domain }}" class="btn btn-secondary">{{ t.back }}</a>
        </div>

        <form id="agent-form" class="agent-form" method="POST" action="javascript:void(0);">
            <!-- Name -->
            <div class="form-group">
                <label for="name">{{ t.name }} *</label>
                <input type="text" id="name" name="name" value="{{ agent.name if agent else '' }}" required>
            </div>

            <!-- Bot Info -->
            {% if not agent %}
            <div class="form-group">
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; border: 1px solid var(--border-color);">
                    <p style="margin: 0; color: var(--text-secondary); font-size: 14px;">
                        <strong>–ß–∞—Ç-–±–æ—Ç –¥–ª—è –û—Ç–∫—Ä—ã—Ç—ã—Ö –ª–∏–Ω–∏–π</strong><br>
                        –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç—Å—è –±–æ—Ç –≤ Bitrix24.<br>
                        –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞ –∫ –Ω—É–∂–Ω–æ–π –û—Ç–∫—Ä—ã—Ç–æ–π –ª–∏–Ω–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Bitrix24.
                    </p>
                </div>
            </div>
            {% endif %}

            {% if agent and agent.bot_id %}
            <div class="form-group">
                <div style="background: var(--bg-secondary); padding: 16px; border-radius: 8px; border: 1px solid var(--success);">
                    <p style="margin: 0; color: var(--text-primary); font-size: 14px;">
                        <strong>BOT_ID: {{ agent.bot_id }}</strong><br>
                        <span style="color: var(--text-secondary);">–ë–æ—Ç —Å–æ–∑–¥–∞–Ω –≤ Bitrix24. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –µ–≥–æ –∫ –û—Ç–∫—Ä—ã—Ç–æ–π –ª–∏–Ω–∏–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä–∞.</span>
                    </p>
                </div>
            </div>
            {% endif %}

            <!-- Description -->
            <div class="form-group">
                <label for="description">{{ t.description }}</label>
                <textarea id="description" name="description" rows="2">{{ agent.description if agent else '' }}</textarea>
            </div>

            <!-- System Prompt -->
            <div class="form-group">
                <label for="system_prompt">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</label>
                <textarea id="system_prompt" name="system_prompt" rows="5" placeholder="–í—ã - AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏...">{{ agent.system_prompt if agent else '' }}</textarea>
                <small style="color: var(--text-secondary);">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è AI. –û–ø–∏—à–∏—Ç–µ —Ä–æ–ª—å –±–æ—Ç–∞, –∫–∞–∫ –æ–Ω –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å, –∫–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å.</small>
            </div>

            <!-- OpenAI API Key -->
            <div class="form-group">
                <label for="openai_api_key">{{ t.openai_api_key }} *</label>
                <input type="password" id="openai_api_key" name="openai_api_key"
                       value="{{ agent.openai_api_key if agent else '' }}" required>
            </div>

            <!-- OpenAI Model -->
            <div class="form-group">
                <label for="openai_model">{{ t.openai_model }} *</label>
                <select id="openai_model" name="openai_model" required>
                    {% for model in models %}
                    <option value="{{ model }}" {% if agent and agent.openai_model == model %}selected{% endif %}>
                        {{ model }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Temperature -->
            <div class="form-group">
                <label for="temperature">{{ t.temperature }}: <span id="temp-value">{{ agent.temperature if agent else 0.7 }}</span></label>
                <input type="range" id="temperature" name="temperature" min="0" max="1" step="0.1"
                       value="{{ agent.temperature if agent else 0.7 }}"
                       oninput="document.getElementById('temp-value').textContent = this.value">
            </div>

            <!-- Max Retries -->
            <div class="form-group">
                <label for="max_retries">{{ t.max_retries }}</label>
                <input type="number" id="max_retries" name="max_retries" min="1" max="10"
                       value="{{ agent.max_retries if agent else 3 }}">
            </div>

            <!-- Timezone -->
            <div class="form-group">
                <label for="timezone">{{ t.timezone }}</label>
                <select id="timezone" name="timezone">
                    {% for tz in timezones %}
                    <option value="{{ tz }}" {% if agent and agent.timezone == tz %}selected{% endif %}>
                        {{ tz }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <!-- Working Hours -->
            <div class="form-group">
                <label>{{ t.working_hours }}</label>
                <div class="radio-group">
                    <label>
                        <input type="radio" name="working_hours_mode" value="247"
                               {% if not agent or not agent.working_hours_enabled %}checked{% endif %}
                               onchange="toggleWorkingHours()">
                        {{ t.working_hours_247 }}
                    </label>
                    <label>
                        <input type="radio" name="working_hours_mode" value="custom"
                               {% if agent and agent.working_hours_enabled %}checked{% endif %}
                               onchange="toggleWorkingHours()">
                        {{ t.working_hours_custom }}
                    </label>
                </div>
            </div>

            <!-- Custom Working Hours Schedule -->
            <div id="working-hours-schedule" style="{% if not agent or not agent.working_hours_enabled %}display:none{% endif %}">
                <div class="schedule-grid">
                    {% for day_en, day_key in [('monday', 'monday'), ('tuesday', 'tuesday'), ('wednesday', 'wednesday'),
                                                 ('thursday', 'thursday'), ('friday', 'friday'), ('saturday', 'saturday'),
                                                 ('sunday', 'sunday')] %}
                    <div class="schedule-day">
                        <label>
                            <input type="checkbox" name="day_{{ day_en }}"
                                   {% if agent and agent.working_hours_schedule and agent.working_hours_schedule.get(day_en) %}checked{% endif %}>
                            {{ t[day_key] }}
                        </label>
                        <input type="time" name="from_{{ day_en }}"
                               value="{{ agent.working_hours_schedule.get(day_en, {}).get('from', '09:00') if agent else '09:00' }}">
                        <span>-</span>
                        <input type="time" name="to_{{ day_en }}"
                               value="{{ agent.working_hours_schedule.get(day_en, {}).get('to', '18:00') if agent else '18:00' }}">
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tools -->
            <div class="form-group">
                <label>{{ t.tools }}</label>
                <div class="tools-grid">
                    <label class="tool-item">
                        <input type="checkbox" name="tool_crm_lead_add"
                               {% if agent and 'crm_lead_add' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">crm_lead_add</div>
                            <div class="tool-desc">–°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–∞</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_crm_deal_add"
                               {% if agent and 'crm_deal_add' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">crm_deal_add</div>
                            <div class="tool-desc">–°–æ–∑–¥–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_crm_contact_add"
                               {% if agent and 'crm_contact_add' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">crm_contact_add</div>
                            <div class="tool-desc">–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_crm_lead_get"
                               {% if agent and 'crm_lead_get' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">crm_lead_get</div>
                            <div class="tool-desc">–ü–æ–ª—É—á–∏—Ç—å –ª–∏–¥</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_crm_deal_get"
                               {% if agent and 'crm_deal_get' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">crm_deal_get</div>
                            <div class="tool-desc">–ü–æ–ª—É—á–∏—Ç—å —Å–¥–µ–ª–∫—É</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_transfer_chat_to_user"
                               {% if agent and 'transfer_chat_to_user' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">transfer_chat_to_user</div>
                            <div class="tool-desc">–ü–µ—Ä–µ–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_disconnect_agent_from_chat"
                               {% if agent and 'disconnect_agent_from_chat' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">disconnect_agent_from_chat</div>
                            <div class="tool-desc">–û—Ç–∫–ª—é—á–∏—Ç—å—Å—è –æ—Ç —á–∞—Ç–∞</div>
                        </div>
                    </label>

                    <label class="tool-item">
                        <input type="checkbox" name="tool_get_todays_date"
                               {% if agent and 'get_todays_date' in agent.enabled_tools %}checked{% endif %}>
                        <div class="tool-info">
                            <div class="tool-name">get_todays_date</div>
                            <div class="tool-desc">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Actions -->
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">{{ t.save }}</button>
                <a href="/?DOMAIN={{ domain }}" class="btn btn-secondary">{{ t.cancel }}</a>
            </div>
        </form>

        <!-- Test Chat Section (only for existing agents) -->
        {% if agent %}
        <div class="test-chat-section">
            <div class="section-title">
                <h2>üß™ –¢–µ—Å—Ç–æ–≤—ã–π —á–∞—Ç</h2>
                <p class="section-desc">–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –∞–≥–µ–Ω—Ç–∞ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–∏—Å–∞—Ç—å –≤ Bitrix24</p>
            </div>

            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-welcome">
                        <div class="welcome-icon">üí¨</div>
                        <p>–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≥–µ–Ω—Ç–∞</p>
                    </div>
                </div>

                <div class="chat-input-container">
                    <textarea
                        id="chat-input"
                        class="chat-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        rows="1"
                    ></textarea>
                    <button type="button" id="chat-send-btn" class="chat-send-btn" onclick="sendTestMessage()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        const DOMAIN = "{{ domain }}";
        const AGENT_ID = {{ agent.id if agent else 'null' }};

        console.log('Agent Edit Loaded:', {DOMAIN, AGENT_ID});

        function toggleWorkingHours() {
            const mode = document.querySelector('input[name="working_hours_mode"]:checked').value;
            document.getElementById('working-hours-schedule').style.display = mode === 'custom' ? 'block' : 'none';
        }

        document.getElementById('agent-form').addEventListener('submit', function(e) {
            console.log('=== Form Submit ===');
            e.preventDefault();
            e.stopPropagation();

            const formData = new FormData(this);

            const data = {
                domain: DOMAIN,
                name: formData.get('name'),
                description: formData.get('description') || '',
                system_prompt: formData.get('system_prompt') || '',
                openai_api_key: formData.get('openai_api_key'),
                openai_model: formData.get('openai_model'),
                temperature: parseFloat(formData.get('temperature')),
                max_retries: parseInt(formData.get('max_retries')),
                timezone: formData.get('timezone'),
                working_hours_enabled: formData.get('working_hours_mode') === 'custom' ? 1 : 0,
                working_hours_schedule: {},
                enabled_tools: [],
                is_active: 1
            };

            // Working hours
            if (data.working_hours_enabled) {
                const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                days.forEach(day => {
                    if (formData.get(`day_${day}`)) {
                        data.working_hours_schedule[day] = {
                            from: formData.get(`from_${day}`),
                            to: formData.get(`to_${day}`)
                        };
                    }
                });
            }

            // Tools
            document.querySelectorAll('input[name^="tool_"]').forEach(checkbox => {
                if (checkbox.checked) {
                    data.enabled_tools.push(checkbox.name.replace('tool_', ''));
                }
            });

            console.log('Data:', data);

            const url = AGENT_ID ? `/api/agent/update/${AGENT_ID}` : '/api/agent/create';
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;

            submitBtn.textContent = 'Saving...';
            submitBtn.disabled = true;

            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(data => {
                console.log('Response:', data);
                if (data.success) {
                    window.location.href = `/?DOMAIN=${DOMAIN}`;
                } else {
                    alert(data.error || 'Error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Error: ' + err.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

document.addEventListener('DOMContentLoaded', () => {
    console.log('Agent form loaded');
});

// ========== TEST CHAT FUNCTIONS ==========

let chatHistory = [];
let isWaitingResponse = false;

function sendTestMessage() {
    if (isWaitingResponse) return;

    const input = document.getElementById('chat-input');
    const message = input.value.trim();

    if (!message) return;
    if (!AGENT_ID) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞!');
        return;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —á–∞—Ç
    addMessageToChat('user', message);
    input.value = '';
    autoResizeTextarea(input);

    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showTypingIndicator();
    isWaitingResponse = true;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å
    fetch(`/api/agent/${AGENT_ID}/chat`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            domain: DOMAIN,
            message: message
        })
    })
    .then(res => res.json())
    .then(data => {
        hideTypingIndicator();
        isWaitingResponse = false;

        if (data.error) {
            addMessageToChat('error', `–û—à–∏–±–∫–∞: ${data.error}`);
        } else {
            addMessageToChat('bot', data.response, data.tool_calls, data.usage);
        }
    })
    .catch(err => {
        hideTypingIndicator();
        isWaitingResponse = false;
        addMessageToChat('error', `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${err.message}`);
    });
}

function addMessageToChat(role, content, toolCalls = [], usage = null) {
    const container = document.getElementById('chat-messages');

    // –£–¥–∞–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    const welcome = container.querySelector('.chat-welcome');
    if (welcome) welcome.remove();

    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message chat-message-${role}`;

    let html = '';

    if (role === 'user') {
        html = `
            <div class="message-avatar">üë§</div>
            <div class="message-content">
                <div class="message-text">${escapeHtml(content)}</div>
            </div>
        `;
    } else if (role === 'bot') {
        html = `
            <div class="message-avatar">ü§ñ</div>
            <div class="message-content">
                <div class="message-text">${formatBotMessage(content)}</div>
                ${toolCalls && toolCalls.length > 0 ? `
                    <div class="message-tools">
                        <span class="tools-label">üîß –§—É–Ω–∫—Ü–∏–∏:</span>
                        ${toolCalls.map(tc => `<span class="tool-badge">${tc.function}</span>`).join('')}
                    </div>
                ` : ''}
                ${usage ? `
                    <div class="message-usage">
                        –¢–æ–∫–µ–Ω—ã: ${usage.prompt_tokens || 0} ‚Üí ${usage.completion_tokens || 0} (–≤—Å–µ–≥–æ: ${usage.total_tokens || 0})
                    </div>
                ` : ''}
            </div>
        `;
    } else if (role === 'error') {
        html = `
            <div class="message-avatar">‚ö†Ô∏è</div>
            <div class="message-content">
                <div class="message-text message-error">${escapeHtml(content)}</div>
            </div>
        `;
    }

    msgDiv.innerHTML = html;
    container.appendChild(msgDiv);

    // –°–∫—Ä–æ–ª–ª–∏–º –≤–Ω–∏–∑
    container.scrollTop = container.scrollHeight;
}

function showTypingIndicator() {
    const container = document.getElementById('chat-messages');
    const typingDiv = document.createElement('div');
    typingDiv.className = 'chat-message chat-message-bot typing-indicator';
    typingDiv.id = 'typing-indicator';
    typingDiv.innerHTML = `
        <div class="message-avatar">ü§ñ</div>
        <div class="message-content">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    container.appendChild(typingDiv);
    container.scrollTop = container.scrollHeight;
}

function hideTypingIndicator() {
    const indicator = document.getElementById('typing-indicator');
    if (indicator) indicator.remove();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function formatBotMessage(text) {
    if (!text) return '<em>(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)</em>';
    // –ü—Ä–æ—Å—Ç–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ -> <br>
    return escapeHtml(text).replace(/\n/g, '<br>');
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 150) + 'px';
}

// Event listeners –¥–ª—è —á–∞—Ç–∞
document.addEventListener('DOMContentLoaded', function() {
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        // –ê–≤—Ç–æ-—Ä–µ—Å–∞–π–∑ textarea
        chatInput.addEventListener('input', function() {
            autoResizeTextarea(this);
        });

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)
        chatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendTestMessage();
            }
        });
    }
});

    </script>
</body>
</html>
